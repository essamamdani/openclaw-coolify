# =============================================================================
# OpenClaw Coolify Docker Compose - SECURITY HARDENED + ENHANCED
# =============================================================================
# Based on: https://github.com/essamamdani/openclaw-coolify
# Security analysis: https://docs.openclaw.ai/gateway/security
#
# CRITICAL FIXES APPLIED:
#   1. GATEWAY_TRUSTED_PROXIES restricted to Coolify network (was '*')
#   2. Gateway auth token REQUIRED (fail-closed)
#   3. Read-only root filesystem with tmpfs for temp files
#   4. All Linux capabilities dropped
#   5. no-new-privileges security option
#   6. Resource limits to prevent DoS
#   7. Docker socket proxy (not direct mount)
#   8. Network isolation
#   9. Healthchecks for dependency ordering
#  10. mDNS discovery disabled (prevents info disclosure)
#
# ENHANCEMENTS (2026-02-10):
#  11. Dedicated browser service for web automation (from Coolify template)
#  12. Extended AI provider support (OpenRouter, XAI, Groq, etc.)
#  13. AWS Bedrock integration
#  14. Hooks system support
#  15. Discord/Slack channel support
# =============================================================================

services:
  # ===========================================================================
  # OPENCLAW GATEWAY
  # ===========================================================================
  openclaw:
    build:
      context: .
      args:
        - OPENCLAW_BETA=${OPENCLAW_BETA:-false}
    restart: unless-stopped
    
    # -------------------------------------------------------------------------
    # RESOURCE LIMITS (Prevent DoS / runaway costs)
    # -------------------------------------------------------------------------
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2.0'
        reservations:
          memory: 1G
          cpus: '0.5'
    
    ulimits:
      nofile:
        soft: 65535
        hard: 65535
      nproc:
        soft: 4096
        hard: 8192
    
    # -------------------------------------------------------------------------
    # SECURITY HARDENING
    # -------------------------------------------------------------------------
    # Drop ALL Linux capabilities - Node.js doesn't need any
    cap_drop:
      - ALL
    
    # Prevent privilege escalation via setuid binaries
    security_opt:
      - no-new-privileges:true
    
    # Read-only root filesystem - prevents malware persistence
    read_only: true
    
    # Temp filesystems for runtime needs (in-memory, not persisted)
    tmpfs:
      - /tmp:size=200M,mode=1777,noexec
      - /var/tmp:size=100M,mode=1777,noexec
      - /run:size=50M,mode=755
      - /root/.config:size=50M,mode=755
    
    # -------------------------------------------------------------------------
    # ENVIRONMENT VARIABLES
    # -------------------------------------------------------------------------
    env_file:
      - .env
    
    environment:
      # Docker connection via secure proxy (NOT direct socket mount)
      DOCKER_HOST: tcp://docker-proxy:2375
      
      # OpenClaw core settings
      OPENCLAW_ENABLE_WEBHOOK_PROXY: "1"
      PORT: 18789
      NODE_ENV: production
      NODE_OPTIONS: '--max-old-space-size=4096'
      HOME: /root
      TERM: xterm-256color
      
      # Persistence paths
      HISTFILE: /root/.openclaw/.bash_history
      HISTSIZE: 50000
      HISTSAVE: 50000
      HISTCONTROL: ignoreboth
      
      # Gateway configuration
      OPENCLAW_GATEWAY_BIND: lan
      OPENCLAW_GATEWAY_PORT: ${OPENCLAW_GATEWAY_PORT:-18789}
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
      OPENCLAW_STATE_DIR: /root/.openclaw
      OPENCLAW_WORKSPACE: /root/openclaw-workspace
      
      # =====================================================================
      # SECURITY FIX #1: Restrict trusted proxies to Coolify network ONLY
      # =====================================================================
      # DANGER: '*' allows any IP to spoof X-Forwarded-For headers
      # This enables authentication bypass where attackers appear as localhost
      # Set to your actual Docker network CIDR (check: docker network inspect coolify)
      GATEWAY_TRUSTED_PROXIES: ${GATEWAY_TRUSTED_PROXIES:-10.0.1.0/24,fd78:47c7:1c46::/64}
      
      # =====================================================================
      # SECURITY FIX #2: mDNS discovery mode (prevents info disclosure)
      # =====================================================================
      # 'full' broadcasts: CLI path, SSH port, hostname (helps attackers)
      # 'minimal' broadcasts: only what's needed for device discovery
      # 'off' disables mDNS entirely
      OPENCLAW_MDNS_MODE: ${OPENCLAW_MDNS_MODE:-minimal}
      
      # =====================================================================
      # AI PROVIDER API KEYS (from .env file)
      # =====================================================================
      # Primary providers
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      MISTRAL_API_KEY: ${MISTRAL_API_KEY}
      
      # Extended AI providers (optional)
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY}
      XAI_API_KEY: ${XAI_API_KEY}
      GROQ_API_KEY: ${GROQ_API_KEY}
      CEREBRAS_API_KEY: ${CEREBRAS_API_KEY}
      VENICE_API_KEY: ${VENICE_API_KEY}
      MOONSHOT_API_KEY: ${MOONSHOT_API_KEY}
      KIMI_API_KEY: ${KIMI_API_KEY}
      MINIMAX_API_KEY: ${MINIMAX_API_KEY}
      ZAI_API_KEY: ${ZAI_API_KEY}
      AI_GATEWAY_API_KEY: ${AI_GATEWAY_API_KEY}
      OPENCODE_API_KEY: ${OPENCODE_API_KEY}
      SYNTHETIC_API_KEY: ${SYNTHETIC_API_KEY}
      XIAOMI_API_KEY: ${XIAOMI_API_KEY}
      DEEPGRAM_API_KEY: ${DEEPGRAM_API_KEY}
      
      # GitHub Copilot
      COPILOT_GITHUB_TOKEN: ${COPILOT_GITHUB_TOKEN}
      
      # AWS Bedrock
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      AWS_SESSION_TOKEN: ${AWS_SESSION_TOKEN}
      BEDROCK_PROVIDER_FILTER: ${BEDROCK_PROVIDER_FILTER:-anthropic}
      
      # Ollama (self-hosted)
      OLLAMA_BASE_URL: ${OLLAMA_BASE_URL}
      
      # Base URL overrides
      MOONSHOT_BASE_URL: ${MOONSHOT_BASE_URL:-https://api.moonshot.ai/v1}
      KIMI_BASE_URL: ${KIMI_BASE_URL:-https://api.moonshot.ai/anthropic}
      
      # Model configuration
      OPENCLAW_PRIMARY_MODEL: ${OPENCLAW_PRIMARY_MODEL}
      
      # =====================================================================
      # COMMUNICATION CHANNELS
      # =====================================================================
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      DISCORD_BOT_TOKEN: ${DISCORD_BOT_TOKEN}
      SLACK_BOT_TOKEN: ${SLACK_BOT_TOKEN}
      SLACK_APP_TOKEN: ${SLACK_APP_TOKEN}
      WHATSAPP_ENABLED: ${WHATSAPP_ENABLED}
      
      # =====================================================================
      # OTHER INTEGRATIONS
      # =====================================================================
      ELEVENLABS_API_KEY: ${ELEVENLABS_API_KEY}
      GOOGLE_MAPS_API_KEY: ${GOOGLE_MAPS_API_KEY}
      
      # Google Calendar (gog CLI)
      GOOGLE_CALENDAR_CREDENTIALS_JSON: ${GOOGLE_CALENDAR_CREDENTIALS_JSON}
      GOG_KEYRING_PASSWORD: ${GOG_KEYRING_PASSWORD}
      
      # URLs - Coolify sets SERVICE_FQDN_OPENCLAW
      BASE_URL: 'https://${SERVICE_FQDN_OPENCLAW}'
      PUBLIC_URL: 'https://${SERVICE_FQDN_OPENCLAW}'
      
      # Bootstrap controls
      OPENCLAW_AUTO_BOOTSTRAP: "1"
      OPENCLAW_PRINT_ACCESS: "1"
      
      # Fix for EMFILE/Inotify issues in Docker
      CHOKIDAR_USEPOLLING: "true"
      
      # Git integration (optional)
      GITHUB_TOKEN: ${GITHUB_TOKEN}
      GITHUB_USERNAME: ${GITHUB_USERNAME}
      GITHUB_EMAIL: ${GITHUB_EMAIL}
      
      # SearXNG integration (internal network)
      SEARXNG_API_URL: http://searxng:8080
      
      # Brave Search API (fallback)
      BRAVE_API_KEY: ${BRAVE_API_KEY}
      
      # =====================================================================
      # BROWSER AUTOMATION (dedicated browser service)
      # =====================================================================
      BROWSER_CDP_URL: ${BROWSER_CDP_URL:-http://browser:9222}
      BROWSER_DEFAULT_PROFILE: ${BROWSER_DEFAULT_PROFILE:-openclaw}
      BROWSER_EVALUATE_ENABLED: ${BROWSER_EVALUATE_ENABLED:-true}
      BROWSER_SNAPSHOT_MODE: ${BROWSER_SNAPSHOT_MODE:-efficient}
      BROWSER_REMOTE_TIMEOUT_MS: ${BROWSER_REMOTE_TIMEOUT_MS:-1500}
      BROWSER_REMOTE_HANDSHAKE_TIMEOUT_MS: ${BROWSER_REMOTE_HANDSHAKE_TIMEOUT_MS:-3000}
      
      # =====================================================================
      # HOOKS SYSTEM (custom webhook integrations)
      # =====================================================================
      HOOKS_ENABLED: ${HOOKS_ENABLED:-false}
      HOOKS_PATH: ${HOOKS_PATH:-/root/openclaw-workspace/hooks}
      
      # =====================================================================
      # ADVANCED CONFIGURATION
      # =====================================================================
      # Custom APT packages (comma-separated)
      OPENCLAW_DOCKER_APT_PACKAGES: ${OPENCLAW_DOCKER_APT_PACKAGES}
      
      # Feature flags
      OPENCLAW_BETA: ${OPENCLAW_BETA:-false}
      SANDBOX_CONTAINER: ${SANDBOX_CONTAINER:-true}
    
    # -------------------------------------------------------------------------
    # VOLUMES (Only writable locations)
    # -------------------------------------------------------------------------
    volumes:
      - openclaw-config:/root/.openclaw
      - openclaw-workspace:/root/openclaw-workspace
      - openclaw-home:/home/node  # Persist Playwright browsers & tool caches
    
    # -------------------------------------------------------------------------
    # DEPENDENCIES
    # -------------------------------------------------------------------------
    depends_on:
      docker-proxy:
        condition: service_healthy
      browser:
        condition: service_healthy
    
    # -------------------------------------------------------------------------
    # HEALTHCHECK (Simple HTTP check - doesn't require gateway pairing)
    # -------------------------------------------------------------------------
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:18789/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s
    
    # -------------------------------------------------------------------------
    # PORT EXPOSURE (Critical for Traefik routing)
    # -------------------------------------------------------------------------
    expose:
      - "18789"
    
    # -------------------------------------------------------------------------
    # STARTUP COMMAND
    # -------------------------------------------------------------------------
    command: ["bash", "/app/scripts/bootstrap.sh"]
    
    # -------------------------------------------------------------------------
    # TRAEFIK LABELS (Coolify handles routing - we only define middlewares)
    # -------------------------------------------------------------------------
    # NOTE: Do NOT define custom routers here - Coolify auto-generates them
    # with proper variable substitution. We only define middleware configs.
    labels:
      # Coolify healthcheck configuration
      - "coolify.healthcheck.enabled=true"
      - "coolify.healthcheck.path=/"
      - "coolify.healthcheck.interval=30s"
      - "coolify.healthcheck.timeout=10s"
      - "coolify.healthcheck.retries=3"
      - "coolify.healthcheck.start_period=90s"
      
      # Traefik service configuration (helps Traefik find the service)
      - "traefik.enable=true"
      - "traefik.http.services.openclaw.loadbalancer.server.port=18789"
      - "traefik.http.services.openclaw.loadbalancer.server.scheme=http"
      
      # Health check for Traefik
      - "traefik.http.services.openclaw.loadbalancer.healthcheck.path=/"
      - "traefik.http.services.openclaw.loadbalancer.healthcheck.interval=30s"
      - "traefik.http.services.openclaw.loadbalancer.healthcheck.timeout=10s"
      
      # Rate limiting middleware (prevents DoS/brute force)
      - "traefik.http.middlewares.openclaw-ratelimit.ratelimit.average=100"
      - "traefik.http.middlewares.openclaw-ratelimit.ratelimit.burst=50"
      - "traefik.http.middlewares.openclaw-ratelimit.ratelimit.period=1m"
    
    # -------------------------------------------------------------------------
    # NETWORK (Isolated from other services)
    # -------------------------------------------------------------------------
    networks:
      - openclaw-internal
      - coolify

  # ===========================================================================
  # BROWSER SERVICE (Web automation with Chrome)
  # ===========================================================================
  # Dedicated browser container for web scraping, testing, and automation.
  # Uses Chrome with remote debugging protocol (CDP) for OpenClaw integration.
  # ===========================================================================
  browser:
    image: 'coollabsio/openclaw-browser:latest'
    restart: unless-stopped
    
    # -------------------------------------------------------------------------
    # RESOURCE LIMITS
    # -------------------------------------------------------------------------
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.25'
    
    # -------------------------------------------------------------------------
    # SECURITY HARDENING (adapted for Chrome requirements)
    # -------------------------------------------------------------------------
    # Chrome needs SYS_ADMIN for sandboxing
    # LinuxServer.io image needs CHOWN, SETUID, SETGID for s6-overlay init
    cap_drop:
      - ALL
    cap_add:
      - SYS_ADMIN  # Required for Chrome's internal sandbox
      - CHOWN      # Required for s6-overlay to change file ownership
      - SETUID     # Required for s6-overlay to switch users
      - SETGID     # Required for s6-overlay to switch groups
    
    security_opt:
      - no-new-privileges:true
    
    # Note: Chrome cannot run with read_only filesystem
    # We accept this trade-off for browser functionality
    
    # -------------------------------------------------------------------------
    # ENVIRONMENT
    # -------------------------------------------------------------------------
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-Etc/UTC}
      - CHROME_CLI=--remote-debugging-port=9222 --remote-debugging-address=0.0.0.0
    
    # -------------------------------------------------------------------------
    # VOLUMES
    # -------------------------------------------------------------------------
    volumes:
      - browser-data:/config
    
    # -------------------------------------------------------------------------
    # TMPFS (for NGINX logs and temp files)
    # -------------------------------------------------------------------------
    tmpfs:
      - /var/log/nginx:size=50M,mode=755
      - /tmp:size=100M,mode=1777
    
    # -------------------------------------------------------------------------
    # SHARED MEMORY (Required for Chrome stability)
    # -------------------------------------------------------------------------
    # Chrome uses shared memory for inter-process communication
    shm_size: 2g
    
    # -------------------------------------------------------------------------
    # HEALTHCHECK
    # -------------------------------------------------------------------------
    healthcheck:
      test: ["CMD-SHELL", "bash -c ':> /dev/tcp/127.0.0.1/9222' || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 30s
    
    # -------------------------------------------------------------------------
    # NETWORK
    # -------------------------------------------------------------------------
    networks:
      - openclaw-internal

  # ===========================================================================
  # DOCKER SOCKET PROXY (Security barrier)
  # ===========================================================================
  # NEVER mount /var/run/docker.sock directly into openclaw container!
  # This proxy exposes only the Docker APIs that OpenClaw actually needs.
  # ===========================================================================
  docker-proxy:
    image: tecnativa/docker-socket-proxy:latest
    restart: unless-stopped
    
    # Security hardening
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    read_only: true
    
    # tmpfs for haproxy (needs /tmp for config, /run for pidfile)
    tmpfs:
      - /tmp:size=10M,mode=1777
      - /run:size=10M,mode=755
    
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    
    environment:
      LOG_LEVEL: info
      
      # =====================================================================
      # SECURITY: Only enable APIs that OpenClaw needs
      # =====================================================================
      # ALLOWED (required for sandbox functionality):
      POST: 1        # Create containers
      CONTAINERS: 1  # List/manage containers
      IMAGES: 1      # Pull images
      NETWORKS: 1    # Connect to networks
      INFO: 1        # Version check
      VERSION: 1     # Version info
      EXEC: 1        # Run commands in containers
      EVENTS: 1      # Listen for container events
      
      # DENIED (dangerous - never enable):
      BUILD: 0       # Would allow building arbitrary images
      COMMIT: 0      # Would allow creating images from containers
      CONFIGS: 0     # Swarm configs
      DISTRIBUTION: 0
      GRPC: 0
      NODES: 0       # Swarm nodes
      PLUGINS: 0     # Plugin management
      SECRETS: 0     # Swarm secrets
      SERVICES: 0    # Swarm services
      SESSION: 0
      SWARM: 0       # Swarm management
      SYSTEM: 0      # System-wide operations
      TASKS: 0       # Swarm tasks
      VOLUMES: 0     # Would allow accessing host volumes
    
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:2375/version"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    
    networks:
      - openclaw-internal

  # ===========================================================================
  # SEARXNG (Private search engine)
  # ===========================================================================
  searxng:
    build:
      context: .
      dockerfile: searxng/Dockerfile
    restart: unless-stopped
    
    # Security hardening
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    security_opt:
      - no-new-privileges:true
    read_only: true
    
    tmpfs:
      - /tmp:size=50M,mode=1777
    
    volumes:
      - searxng-data:/var/lib/searxng
    
    environment:
      SEARXNG_BASE_URL: http://searxng:8080
      SEARXNG_SERVER_SECRET_KEY: ${SERVICE_BASE64_SEARXNG}
    
    networks:
      - openclaw-internal

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  openclaw-internal:
    driver: bridge
    # internal: false  # Needs internet access for Telegram/Anthropic APIs
  coolify:
    external: true

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  openclaw-config:
    name: openclaw-config
  openclaw-workspace:
    name: openclaw-workspace
  openclaw-home:
    name: openclaw-home  # Persists Playwright browsers, npm cache, tool caches
  searxng-data:
    name: searxng-data
  browser-data:
    name: browser-data  # Persists Chrome profiles and browser data
